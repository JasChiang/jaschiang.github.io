<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„åœ¨åœ°æ˜Ÿç©º Â· GitHub Pages</title>
  <meta name="description" content="æ ¹æ“šç€è¦½è€…åœ°é»èˆ‡æ™‚é–“é¡¯ç¤ºæ˜Ÿç©ºï¼Œæ”¯æ´æ™‚é–“æ’­æ”¾èˆ‡æ‰‹å‹•è¨­å®šç¶“ç·¯åº¦ã€‚" />
  <style>
    :root { --bg:#0b1020; --fg:#e6e9ef; --muted:#9aa0a6; --accent:#7aa2f7; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; }
    header { padding:1rem 1.25rem; display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; justify-content:space-between; }
    h1 { font-size:1.1rem; margin:0; letter-spacing:.02em; }
    a, button, input, select { font:inherit; color:inherit; }
    .controls { display:flex; flex-wrap:wrap; gap:.5rem .75rem; align-items:center; }
    .group { display:flex; gap:.4rem; align-items:center; }
    .group label { color:var(--muted); font-size:.92rem; }
    input[type="number"] { width:7ch; padding:.35rem .5rem; border:1px solid #1f2438; border-radius:.4rem; background:#0f1530; color:var(--fg); }
    input[type="range"] { width:220px; }
    button { padding:.45rem .7rem; border:1px solid #1f2438; background:#101633; border-radius:.5rem; cursor:pointer; }
    button:hover { border-color:#2a3355; }
    .pill { background:#101633; border-radius:999px; padding:.25rem .6rem; color:var(--muted); border:1px solid #1f2438; }
    #sky { width:100%; height:calc(100% - 148px); }
    footer { color:var(--muted); font-size:.85rem; padding:.5rem 1.25rem 1rem; display:flex; justify-content:space-between; gap:.75rem; flex-wrap:wrap; }
    .links a { color:var(--muted); text-decoration:none; border-bottom:1px dotted #2d3350; }
    .toggle { display:flex; gap:.5rem; align-items:center; }
    .banner { position:fixed; inset:auto 1rem 1rem 1rem; background:#101633; border:1px solid #27305a; border-radius:.75rem; padding:.75rem 1rem; color:#e6e9ef; box-shadow:0 10px 30px rgba(0,0,0,.3); display:none; white-space:pre-wrap; }
    .banner.error { display:block; }
    .testlog { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85rem; line-height:1.35; white-space:pre-wrap; background:#0f1530; border:1px solid #1f2438; border-radius:.5rem; padding:.5rem .75rem; max-height:260px; overflow:auto; }
    details summary { cursor:pointer; }
    noscript { display:block; margin:1rem; padding:1rem; background:#3b1d1d; border:1px solid #6a2a2a; border-radius:.5rem; color:#ffecec; }
  </style>

  <!-- âœ… åƒ…è¼‰å…¥æœ¬åœ° /vendor æª”æ¡ˆï¼›ä¸é€£ä»»ä½• CDNï¼Œæœ€ç›¸å®¹æœ¬æ©Ÿ file:// é–‹å•Ÿ -->
  <script src="./vendor/d3.min.js"></script>
  <script src="./vendor/celestial.min.js"></script>
</head>
<body>
  <noscript>æ­¤ç¶²ç«™éœ€è¦ JavaScript æ‰èƒ½é‹ä½œã€‚è«‹å•Ÿç”¨å¾Œé‡æ–°è¼‰å…¥ã€‚</noscript>
  <header>
    <h1>æˆ‘çš„åœ¨åœ°æ˜Ÿç©º</h1>
    <div class="controls">
      <span class="pill" id="locStatus">åˆå§‹åŒ–ä¸­â€¦</span>
      <div class="group">
        <label>ç·¯åº¦</label><input id="lat" type="number" step="0.0001" placeholder="25.033" />
        <label>ç¶“åº¦</label><input id="lng" type="number" step="0.0001" placeholder="121.565" />
        <button id="applyLL">å¥—ç”¨</button>
        <button id="useGPS">ä½¿ç”¨å®šä½</button>
      </div>
      <div class="group">
        <label>æ™‚é–“</label>
        <input id="timeSlider" type="range" min="-12" max="12" value="0" step="0.25" />
        <span class="pill" id="timeLabel">ç¾åœ¨</span>
        <button id="play">â–¶ï¸ æ’­æ”¾</button>
        <button id="now">å›åˆ°ç¾åœ¨</button>
      </div>
      <div class="toggle">
        <label><input id="toggleConst" type="checkbox" checked /> æ˜Ÿåº§ç·š</label>
        <label><input id="toggleNames" type="checkbox" /> æ˜Ÿåº§å</label>
        <label><input id="toggleMW" type="checkbox" checked /> éŠ€æ²³</label>
        <label><input id="toggleGraticule" type="checkbox" /> ç¶“ç·¯ç¶²</label>
      </div>
    </div>
  </header>

  <div id="sky"></div>

  <footer>
    <div>åœ°é»ï¼š
      <span id="locText">â€”</span>ï½œæ™‚åˆ»ï¼š
      <span id="utcText">â€”</span>ï¼ˆè‡ªå‹•ä¾æ‰€åœ¨æ™‚å€ï¼‰
    </div>
    <div class="links">
      è³‡æ–™èˆ‡ç¹ªåœ–ï¼šd3â€‘celestial ï½œ
      <details style="display:inline-block">
        <summary>è‡ªæˆ‘æ¸¬è©¦</summary>
        <div class="testlog" id="testLog">å°šæœªåŸ·è¡Œæ¸¬è©¦ã€‚</div>
        <button id="runTests">åŸ·è¡Œè‡ªæˆ‘æ¸¬è©¦</button>
      </details>
    </div>
  </footer>

  <div class="banner" id="errorBanner"></div>

  <script>
  // ====== å•Ÿå‹•ï¼ˆç´”æœ¬åœ°ä¾è³´ç‰ˆï¼‰ ======
  (function boot() {
    const skyNode = document.getElementById('sky');
    const banner = document.getElementById('errorBanner');
    const setStatus = (t) => { document.getElementById('locStatus').textContent = String(t); };
    const showError = (msg) => { banner.textContent = String(msg); banner.classList.add('error'); console.error(msg); };

    // 1) æª¢æŸ¥æœ¬åœ°å¥—ä»¶æ˜¯å¦å­˜åœ¨
    if (!window.d3 || !window.Celestial) {
      const baseDir = location.href.replace(/[^\/]*$/, '');
      const tried = [
        new URL('./vendor/d3.min.js', baseDir).href,
        new URL('./vendor/celestial.min.js', baseDir).href
      ].join('\n');
      showError([
        'ç„¡æ³•è¼‰å…¥å¿…è¦å¥—ä»¶ï¼ˆåƒ…ä½¿ç”¨æœ¬åœ° /vendorï¼Œä¸é€£å¤–éƒ¨ CDNï¼‰ã€‚',
        '',
        'è«‹ç¢ºèªé€™å…©å€‹æª”æ¡ˆå­˜åœ¨ä¸”æª”åå¤§å°å¯«æ­£ç¢ºï¼š',
        '  /vendor/d3.min.js',
        '  /vendor/celestial.min.js',
        '',
        'ç›®å‰é é¢ä½ç½®ï¼š',
        '  ' + location.href,
        'é æœŸå˜—è©¦è·¯å¾‘ï¼š',
        '  ' + tried,
        '',
        'è‹¥ä»ä¸è¡Œï¼Œè«‹æ”¹ç”¨æœ¬æ©Ÿä¼ºæœå™¨åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å•Ÿå‹•ï¼š',
        '  Python:  python3 -m http.server 8080',
        '  Node:    npx http-server -p 8080'
      ].join('\n'));
      setStatus('ç­‰å¾…æœ¬åœ°å¥—ä»¶â€¦');
      return;
    }

    // 2) åˆå§‹åŒ– d3-celestial
    setStatus('åˆå§‹åŒ–ä¸­â€¦');

    const cfg = {
      width: skyNode.clientWidth,
      height: skyNode.clientHeight,
      projection: 'airy',
      transform: 'equatorial',
      center: [0, 0, 0],
      location: null,
      form: false,
      datapath: 'https://ofrohn.github.io/data/', // è‹¥ä½ ä¹Ÿè¦é›¢ç·šï¼Œå¯æ”¹æˆæœ¬åœ°é¡åƒ
      stars: { show: true, size: 3, exponent: -0.25, data: 'stars.6.json', designation: false, propername: true, namesType: 'name' },
      dsos: { show: false },
      constellations: { names: false, namesType: 'name', lines: true, lineStyle: { stroke: '#668', width: 0.6, opacity: 0.6 }, bounds: false },
      mw: { show: true, style: { fill: '#223', opacity: 0.7 } },
      lines: { graticule: { show: false } },
      background: { fill: '#000', stroke: '#000', opacity: 1 },
      horizon: { show: true }
    };

    try {
      Celestial.display(cfg);
    } catch (e) {
      showError('åˆå§‹åŒ– Celestial å¤±æ•—ï¼š' + (e && e.message ? e.message : e));
      return;
    }

    let playTimer = null;
    let baseDate = new Date();
    let hourOffset = 0;
    let observer = { latitude: 0, longitude: 0 };

    function updateTimeLabel() {
      const label = hourOffset === 0 ? 'ç¾åœ¨' : (hourOffset > 0 ? `+${hourOffset.toFixed(2)} å°æ™‚` : `${hourOffset.toFixed(2)} å°æ™‚`);
      document.getElementById('timeLabel').textContent = label;
    }
    function effectiveDate() {
      const d = new Date(baseDate);
      d.setMinutes(d.getMinutes() + Math.round(hourOffset * 60));
      return d;
    }
    function render() {
      const when = effectiveDate();
      document.getElementById('utcText').textContent = when.toLocaleString(undefined, { timeZoneName: 'short' });
      document.getElementById('locText').textContent = `${observer.latitude.toFixed(4)}, ${observer.longitude.toFixed(4)}`;
      Celestial.observe({ latitude: observer.latitude, longitude: observer.longitude, elevation: 0 });
      Celestial.date(when);
      Celestial.redraw();
    }

    // ---- UI ç¶å®š
    document.getElementById('toggleConst').addEventListener('change', (e) => { Celestial.constellations({ lines: e.target.checked }); Celestial.redraw(); });
    document.getElementById('toggleNames').addEventListener('change', (e) => { Celestial.constellations({ names: e.target.checked }); Celestial.redraw(); });
    document.getElementById('toggleMW').addEventListener('change', (e) => { Celestial.milkyway({ show: e.target.checked }); Celestial.redraw(); });
    document.getElementById('toggleGraticule').addEventListener('change', (e) => { Celestial.grid({ graticule: { show: e.target.checked } }); Celestial.redraw(); });

    document.getElementById('timeSlider').addEventListener('input', (e) => { hourOffset = parseFloat(e.target.value); updateTimeLabel(); render(); });

    document.getElementById('play').addEventListener('click', () => {
      if (playTimer) {
        clearInterval(playTimer); playTimer = null;
        document.getElementById('play').textContent = 'â–¶ï¸ æ’­æ”¾';
      } else {
        playTimer = setInterval(() => {
          hourOffset = Math.min(12, Math.max(-12, hourOffset + (10/60)));
          document.getElementById('timeSlider').value = hourOffset;
          updateTimeLabel(); render();
          if (hourOffset >= 12) hourOffset = -12;
        }, 250);
        document.getElementById('play').textContent = 'â¸ æš«åœ';
      }
    });

    document.getElementById('now').addEventListener('click', () => {
      baseDate = new Date(); hourOffset = 0;
      document.getElementById('timeSlider').value = 0; updateTimeLabel(); render();
    });

    document.getElementById('applyLL').addEventListener('click', () => {
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      if (Number.isFinite(lat) && Number.isFinite(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
        observer = { latitude: lat, longitude: lng };
        document.getElementById('locStatus').textContent = 'å·²å¥—ç”¨æ‰‹å‹•åœ°é»';
        render();
      } else {
        document.getElementById('locStatus').textContent = 'ç¶“ç·¯åº¦æ ¼å¼ä¸æ­£ç¢º';
      }
    });

    document.getElementById('useGPS').addEventListener('click', () => { getLocation(true); });

    function getLocation(force=false) {
      if (!navigator.geolocation) { document.getElementById('locStatus').textContent = 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ç¶“ç·¯åº¦ã€‚'; return; }
      document.getElementById('locStatus').textContent = force ? 'é‡æ–°å®šä½ä¸­â€¦' : 'å®šä½ä¸­â€¦';
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          observer.latitude = pos.coords.latitude; observer.longitude = pos.coords.longitude;
          document.getElementById('lat').value = observer.latitude.toFixed(4);
          document.getElementById('lng').value = observer.longitude.toFixed(4);
          document.getElementById('locStatus').textContent = 'å·²å–å¾—å®šä½';
          render();
        },
        (err) => {
          console.warn(err);
          document.getElementById('locStatus').textContent = 'å®šä½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ç¶“ç·¯åº¦ã€‚';
          if (!Number.isFinite(observer.latitude) || !Number.isFinite(observer.longitude)) {
            observer = { latitude: 25.0330, longitude: 121.5654 }; // é è¨­å°åŒ—
            document.getElementById('lat').value = observer.latitude.toFixed(4);
            document.getElementById('lng').value = observer.longitude.toFixed(4);
            render();
          }
        },
        { enableHighAccuracy: false, timeout: 8000, maximumAge: 600000 }
      );
    }

    // ====== è‡ªæˆ‘æ¸¬è©¦ï¼ˆæ¸¬è©¦æ¡ˆä¾‹ï¼‰ ======
    const testLog = document.getElementById('testLog');
    document.getElementById('runTests').addEventListener('click', () => {
      const logs = [];
      const ok = (name) => logs.push(`âœ… ${name}`);
      const fail = (name, e) => logs.push(`âŒ ${name} â†’ ${e && e.message ? e.message : e}`);
      try { window.d3 ? ok('d3 å­˜åœ¨') : fail('d3 å­˜åœ¨', 'd3 æœªè¼‰å…¥'); } catch(e) { fail('d3 å­˜åœ¨', e); }
      try { window.Celestial ? ok('Celestial å­˜åœ¨') : fail('Celestial å­˜åœ¨', 'Celestial æœªè¼‰å…¥'); } catch(e) { fail('Celestial å­˜åœ¨', e); }
      try { typeof Celestial.display === 'function' ? ok('Celestial.display å¯ç”¨') : fail('Celestial.display å¯ç”¨', 'ä¸æ˜¯ function'); } catch(e) { fail('Celestial.display å¯ç”¨', e); }
      try { Celestial.redraw(); ok('Celestial.redraw åŸ·è¡Œ'); } catch(e) { fail('Celestial.redraw åŸ·è¡Œ', e); }
      try { Celestial.constellations({ lines: true }); Celestial.redraw(); ok('åˆ‡æ›æ˜Ÿåº§ç·š'); } catch(e) { fail('åˆ‡æ›æ˜Ÿåº§ç·š', e); }
      try { Celestial.grid({ graticule: { show: true } }); Celestial.redraw(); Celestial.grid({ graticule: { show: false } }); ok('åˆ‡æ›ç¶“ç·¯ç¶²'); } catch(e) { fail('åˆ‡æ›ç¶“ç·¯ç¶²', e); }
      try { window.dispatchEvent(new Event('resize')); ok('è§¸ç™¼ resize'); } catch(e) { fail('è§¸ç™¼ resize', e); }
      // é©—è­‰éŒ¯èª¤å­—ä¸²ä¸å«éæ³•åˆ†è¡Œç¬¦ï¼ˆé¿å… SyntaxErrorï¼‰
      try { const msg = 'æ¸¬è©¦\nA\nB\nC\næœ€å¾ŒéŒ¯èª¤ï¼šX'; if (/\u2028|\u2029/.test(msg)) throw new Error('å« U+2028/U+2029'); ok('éŒ¯èª¤è¨Šæ¯ä¸å«éæ³•æ›è¡Œç¬¦'); } catch(e) { fail('éŒ¯èª¤è¨Šæ¯ä¸å«éæ³•æ›è¡Œç¬¦', e); }
      // textContent å¯«å…¥ç‰¹æ®Šå­—å…ƒ
      try { const el = document.getElementById('locStatus'); const prev = el.textContent; el.textContent = 'æ¸¬è©¦âœ“ğŸš€ â€“ æ­£å¸¸'; if (!el.textContent.includes('ğŸš€')) throw new Error('Emoji æœªæ­£ç¢ºå¯«å…¥'); el.textContent = prev; ok('textContent å¯«å…¥ç‰¹æ®Šå­—å…ƒ'); } catch(e) { fail('textContent å¯«å…¥ç‰¹æ®Šå­—å…ƒ', e); }
      testLog.textContent = logs.join('\n');
    });

    updateTimeLabel();
    getLocation(false);
    window.addEventListener('resize', () => {
      Celestial.resize({ width: skyNode.clientWidth, height: skyNode.clientHeight });
      Celestial.redraw();
    });
    setStatus('å·²è¼‰å…¥ï¼Œæ­£åœ¨å®šä½â€¦');
  })();
  </script>
</body>
</html>