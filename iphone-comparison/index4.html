<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone 比較圖表</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        .header {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .device-image {
            width: 100px;
            cursor: pointer;
        }
        .colors {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .editable {
            border: 1px dashed #ccc;
            padding: 5px;
            cursor: pointer;
            position: relative;
            min-height: 50px;
        }
        .editable.editing {
            border: 1px solid #ccc;
            outline: none;
        }
        .edit-buttons {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
        }
        .editable.editing .edit-buttons {
            display: block;
        }
        #export-button, #add-row-button, #add-common-row-button, #add-two-device-row-button {
            margin-top: 20px;
            margin-right: 10px;
        }
        tr.draggable {
            cursor: move;
        }
        .toolbar {
            display: none;
            position: absolute;
            background: #f1f1f1;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1000;
        }
        .toolbar button, .toolbar select {
            margin-right: 5px;
        }
        .resizable-image {
            position: absolute;
            display: inline-block;
            margin: 5px;
        }
        .resizable-image img {
            display: block;
            max-width: 100%;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #00f;
            right: -5px;
            bottom: -5px;
            cursor: se-resize;
        }
    </style>
</head>
<body>
    <table class="comparison-table" id="comparison-table">
        <tr class="header" draggable="false">
            <th colspan="2">iPhone 15</th>
            <th colspan="2">iPhone 15 Pro</th>
        </tr>
        <tr draggable="true" class="draggable">
            <td class="editable">
                <div>
                    <img src="iphone15.png" alt="iPhone 15" class="device-image" id="iphone15-img">
                </div>
            </td>
            <td class="editable">
                <div>
                    <img src="iphone15plus.png" alt="iPhone 15 Plus" class="device-image" id="iphone15plus-img">
                </div>
            </td>
            <td class="editable">
                <div>
                    <img src="iphone15pro.png" alt="iPhone 15 Pro" class="device-image" id="iphone15pro-img">
                </div>
            </td>
            <td class="editable">
                <div>
                    <img src="iphone15promax.png" alt="iPhone 15 Pro Max" class="device-image" id="iphone15promax-img">
                </div>
            </td>
        </tr>
        <tr draggable="true" class="draggable">
            <td class="editable"><div>iPhone 15</div></td>
            <td class="editable"><div>iPhone 15 Plus</div></td>
            <td class="editable"><div>iPhone 15 Pro</div></td>
            <td class="editable"><div>iPhone 15 Pro Max</div></td>
        </tr>
        <tr draggable="true" class="draggable">
            <td class="editable"><div>6.1 吋</div></td>
            <td class="editable"><div>6.7 吋</div></td>
            <td class="editable"><div>6.1 吋</div></td>
            <td class="editable"><div>6.7 吋</div></td>
        </tr>
        <tr draggable="true" class="draggable">
            <td colspan="2" class="editable">
                <div>
                    <div class="colors">
                        <div class="color" style="background-color: #e0e0e0;"></div>
                        <div class="color" style="background-color: #f08080;"></div>
                        <div class="color" style="background-color: #90ee90;"></div>
                        <div class="color" style="background-color: #add8e6;"></div>
                        <div class="color" style="background-color: #d3d3d3;"></div>
                    </div>
                </div>
            </td>
            <td colspan="2" class="editable">
                <div>
                    <div class="colors">
                        <div class="color" style="background-color: #000;"></div>
                        <div class="color" style="background-color: #fff;"></div>
                        <div class="color" style="background-color: #808080;"></div>
                        <div class="color" style="background-color: #c0c0c0;"></div>
                        <div class="color" style="background-color: #d3d3d3;"></div>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    <input type="file" id="image-upload" style="display: none;">
    <button id="add-row-button">增加功能排</button>
    <button id="add-common-row-button">增加共同功能排</button>
    <button id="add-two-device-row-button">增加兩機共同功能排</button>
    <button id="export-button">匯出圖片</button>

    <div id="toolbar" class="toolbar">
        <button onclick="formatText('bold')">粗體</button>
        <button onclick="formatText('italic')">斜體</button>
        <button onclick="formatText('underline')">底線</button>
        <input type="color" onchange="changeColor(this.value)">
        <button onclick="insertImage()">插入圖片</button>
    </div>

    <script>
        let currentEditableElement = null;
        let currentResizableImage = null;

        function attachEditor(cell) {
            const div = cell.querySelector('div');
            if (!div) return;

            div.addEventListener('click', (event) => {
                if (!cell.classList.contains('editing')) {
                    startEditing(cell);
                }
            });
        }

        function startEditing(cell) {
            if (currentEditableElement) {
                finishEditing(currentEditableElement);
            }

            currentEditableElement = cell;
            const div = cell.querySelector('div');
            cell.classList.add('editing');
            div.contentEditable = 'true';
            div.focus();

            const existingButtons = cell.querySelector('.edit-buttons');
            if (existingButtons) {
                existingButtons.remove();
            }

            const editButtons = document.createElement('div');
            editButtons.className = 'edit-buttons';
            editButtons.innerHTML = '<button class="save-button">完成</button>';
            cell.appendChild(editButtons);

            editButtons.querySelector('.save-button').addEventListener('click', () => {
                finishEditing(cell);
            });

            showToolbar(cell);
        }

        function finishEditing(cell) {
            cell.classList.remove('editing');
            const div = cell.querySelector('div');
            div.contentEditable = 'false';
            const editButtons = cell.querySelector('.edit-buttons');
            if (editButtons) {
                editButtons.remove();
            }
            hideToolbar();
            currentEditableElement = null;
        }

        function showToolbar(cell) {
            const toolbar = document.getElementById('toolbar');
            toolbar.style.display = 'block';
            const rect = cell.getBoundingClientRect();
            toolbar.style.top = `${rect.bottom + window.scrollY}px`;
            toolbar.style.left = `${rect.left + window.scrollX}px`;
        }

        function hideToolbar() {
            document.getElementById('toolbar').style.display = 'none';
        }

        function formatText(command) {
            document.execCommand(command, false, null);
        }

        function changeColor(color) {
            document.execCommand('foreColor', false, color);
        }

        function insertImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    const image = new Image();
                    image.src = readerEvent.target.result;
                    image.onload = function() {
                        const aspectRatio = this.width / this.height;
                        const newWidth = 150;
                        const newHeight = newWidth / aspectRatio;
                        
                        const resizableImage = document.createElement('div');
                        resizableImage.className = 'resizable-image';
                        resizableImage.style.position = 'absolute';
                        resizableImage.style.width = `${newWidth}px`;
                        resizableImage.style.height = `${newHeight}px`;
                        resizableImage.innerHTML = `
                            <img src="${this.src}" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; cursor: move;">
                            <span class="resize-handle" style="position: absolute; right: -5px; bottom: -5px; width: 10px; height: 10px; background-color: blue; cursor: se-resize;"></span>
                        `;
                        
                        currentEditableElement.appendChild(resizableImage);
                        makeImageResizable(resizableImage);
                        makeImageDraggable(resizableImage);
                    };
                }
                reader.readAsDataURL(file);
            }
            input.click();
        }

        function makeImageDraggable(resizableImage) {
            const img = resizableImage.querySelector('img');
            let isDragging = false;
            let startX, startY;

            img.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX - resizableImage.offsetLeft;
                startY = e.clientY - resizableImage.offsetTop;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const newX = e.clientX - startX;
                const newY = e.clientY - startY;

                resizableImage.style.left = `${newX}px`;
                resizableImage.style.top = `${newY}px`;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        function makeImageResizable(resizableImage) {
            const handle = resizableImage.querySelector('.resize-handle');
            let startX, startY, startWidth, startHeight;

            function initResize(e) {
                startX = e.clientX;
                startY = e.clientY;
                startWidth = resizableImage.offsetWidth;
                startHeight = resizableImage.offsetHeight;
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            }

            function resize(e) {
                const width = startWidth + e.clientX - startX;
                const height = startHeight + e.clientY - startY;
                resizableImage.style.width = `${width}px`;
                resizableImage.style.height = `${height}px`;
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }

            handle.addEventListener('mousedown', initResize);
        }

        // 處理複製貼上的圖片
        document.addEventListener('paste', (event) => {
            if (currentEditableElement) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file') {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = function() {
                                const aspectRatio = this.width / this.height;
                                const newWidth = 150;
                                const newHeight = newWidth / aspectRatio;
                                
                                const resizableImage = document.createElement('div');
                                resizableImage.className = 'resizable-image';
                                resizableImage.style.position = 'absolute';
                                resizableImage.style.width = `${newWidth}px`;
                                resizableImage.style.height = `${newHeight}px`;
                                resizableImage.innerHTML = `
                                    <img src="${this.src}" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; cursor: move;">
                                    <span class="resize-handle" style="position: absolute; right: -5px; bottom: -5px; width: 10px; height: 10px; background-color: blue; cursor: se-resize;"></span>
                                `;
                                
                                currentEditableElement.appendChild(resizableImage);
                                makeImageResizable(resizableImage);
                                makeImageDraggable(resizableImage);
                            };
                        };
                        reader.readAsDataURL(blob);
                    }
                }
            }
        });

        document.querySelectorAll('.device-image').forEach(img => {
            img.addEventListener('click', (event) => {
                event.stopPropagation();
                const input = document.getElementById('image-upload');
                input.click();
                input.onchange = function (event) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        img.src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        });

        document.getElementById('export-button').addEventListener('click', () => {
            html2canvas(document.querySelector('table')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'comparison.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        function addNewRow(colspan) {
            const table = document.getElementById('comparison-table');
            const newRow = table.insertRow();
            newRow.draggable = true;
            newRow.classList.add('draggable');
            const cellCount = colspan === 4 ? 1 : (colspan === 2 ? 2 : 4);
            
            for (let i = 0; i < cellCount; i++) {
                const newCell = newRow.insertCell();
                newCell.className = 'editable';
                newCell.colSpan = colspan;
                const div = document.createElement('div');
                div.textContent = '新功能描述';
                newCell.appendChild(div);
                attachEditor(newCell);
            }
        }

        document.getElementById('add-row-button').addEventListener('click', () => addNewRow(1));
        document.getElementById('add-common-row-button').addEventListener('click', () => addNewRow(4));
        document.getElementById('add-two-device-row-button').addEventListener('click', () => addNewRow(2));

        document.querySelectorAll('.editable').forEach(cell => {
            attachEditor(cell);
        });

        document.addEventListener('dragstart', (event) => {
            if (event.target.tagName === 'TR') {
                event.dataTransfer.setData('text/plain', event.target.rowIndex);
            }
        });

        document.addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        document.addEventListener('drop', (event) => {
            if (event.target.tagName === 'TR' || event.target.tagName === 'TD') {
                const table = document.getElementById('comparison-table');
                const fromIndex = event.dataTransfer.getData('text/plain');
                const toIndex = event.target.closest('tr').rowIndex;
                if (fromIndex && toIndex) {
                    const rows = Array.from(table.rows);
                    const fromRow = rows[fromIndex];
                    const toRow = rows[toIndex];
                    if (fromRow && toRow) {
                        if (fromIndex < toIndex) {
                            toRow.parentNode.insertBefore(fromRow, toRow.nextSibling);
                        } else {
                            toRow.parentNode.insertBefore(fromRow, toRow);
                        }
                    }
                }
            }
        });

        function loadHtml2Canvas() {
            const script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            script.onload = () => console.log("html2canvas loaded");
            document.head.appendChild(script);
        }

        loadHtml2Canvas();

        document.addEventListener('click', (event) => {
            if (currentEditableElement && !currentEditableElement.contains(event.target) && !document.getElementById('toolbar').contains(event.target)) {
                finishEditing(currentEditableElement);
            }
        });
    </script>
</body>
</html>
