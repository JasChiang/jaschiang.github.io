<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone 比較圖表 (可調整寬度版本)</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: space-between;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .table-container {
            width: 60%;
            overflow-x: auto;
        }
        .editor-container {
            width: 35%;
            position: fixed;
            right: 20px;
            top: 20px;
        }
        .comparison-table {
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ccc;
            padding: 5px;
            vertical-align: top;
            white-space: normal;
            word-wrap: break-word;
        }
        .header {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .editable {
            cursor: pointer;
            position: relative;
        }
        .editable p {
            margin: 0;
        }
        .editable img {
            max-width: 100%;
            height: auto;
        }
        #add-row-button, #add-common-row-button, #add-two-device-row-button, #export-button, #toggle-width-button {
            margin-top: 20px;
            margin-right: 10px;
        }
        #editor {
            height: 400px;
        }
        .ql-editor img {
            cursor: pointer;
        }
        #paste-button {
            margin-top: 10px;
        }
        .draggable {
            cursor: move;
        }
        .dragging {
            opacity: 0.5;
        }
        .equal-width .comparison-table {
            table-layout: fixed;
        }
        .equal-width .comparison-table th,
        .equal-width .comparison-table td {
            width: 25%;
        }
        #width-control {
            width: 100%;
            margin-top: 10px;
        }
        .ql-align-center {
            text-align: center;
        }
        .ql-align-right {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="table-container">
        <table class="comparison-table" id="comparison-table">
            <tr class="header">
                <th colspan="2" class="editable" onclick="selectCell(this)">iPhone 15</th>
                <th colspan="2" class="editable" onclick="selectCell(this)">iPhone 15 Pro</th>
            </tr>
            <tr class="draggable">
                <td class="editable" onclick="selectCell(this)">iPhone 15</td>
                <td class="editable" onclick="selectCell(this)">iPhone 15 Plus</td>
                <td class="editable" onclick="selectCell(this)">iPhone 15 Pro</td>
                <td class="editable" onclick="selectCell(this)">iPhone 15 Pro Max</td>
            </tr>
        </table>
        <input type="range" id="width-control" min="20" max="100" value="60">
        <button id="add-row-button">增加功能排</button>
        <button id="add-common-row-button">增加共同功能排</button>
        <button id="add-two-device-row-button">增加兩機共同功能排</button>
        <button id="export-button">匯出圖片</button>
        <button id="toggle-width-button">切換等寬/自適應</button>
    </div>
    
    <div class="editor-container">
        <div id="editor"></div>
        <button id="paste-button">粘贴到选中单元格</button>
    </div>

    <script>
        let quill;
        let selectedCell;
        let dragSrcEl = null;
        let isEqualWidth = false;

        function initQuill() {
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        ['image'],
                        [{ 'align': ['', 'center', 'right'] }]
                    ]
                },
                placeholder: '在此輸入內容...'
            });

            quill.root.addEventListener('click', function(e) {
                if (e.target && e.target.tagName === 'IMG') {
                    const size = prompt('输入新的宽度（像素）:', e.target.width);
                    if (size) {
                        e.target.style.width = size + 'px';
                    }
                }
            });
        }

        function selectCell(cell) {
            if (selectedCell) {
                selectedCell.style.outline = 'none';
            }
            selectedCell = cell;
            selectedCell.style.outline = '2px solid blue';
            quill.root.innerHTML = cell.innerHTML;
        }

        function pasteToCell() {
            if (selectedCell) {
                selectedCell.innerHTML = quill.root.innerHTML;
                selectedCell.style.outline = 'none';

                // 确保对齐方式正确应用
                selectedCell.querySelectorAll('.ql-align-center').forEach(el => {
                    el.style.textAlign = 'center';
                });
                selectedCell.querySelectorAll('.ql-align-right').forEach(el => {
                    el.style.textAlign = 'right';
                });

                adjustCellSize(selectedCell);
                adjustTableLayout();

                selectedCell = null;
                quill.root.innerHTML = '';
            } else {
                alert('请先选择一个单元格');
            }
        }

        function adjustCellSize(cell) {
            if (!isEqualWidth) {
                cell.style.width = 'auto';
                cell.style.height = 'auto';
            }
        }

        function adjustTableLayout() {
            const table = document.getElementById('comparison-table');
            if (!isEqualWidth) {
                table.style.width = '100%';
                table.style.tableLayout = 'auto';
            } else {
                table.style.width = '100%';
                table.style.tableLayout = 'fixed';
            }

            // 强制浏览器重新计算布局
            table.offsetHeight;
        }

        function addNewRow(colspan) {
            const table = document.getElementById('comparison-table');
            const newRow = table.insertRow();
            newRow.classList.add('draggable');
            addDragHandlers(newRow);
            const cellCount = colspan === 4 ? 1 : (colspan === 2 ? 2 : 4);
            
            for (let i = 0; i < cellCount; i++) {
                const newCell = newRow.insertCell();
                newCell.className = 'editable';
                newCell.colSpan = colspan;
                newCell.onclick = function() { selectCell(this); };
            }
            adjustTableLayout();
        }

        function addDragHandlers(row) {
            row.setAttribute('draggable', true);
            row.addEventListener('dragstart', handleDragStart, false);
            row.addEventListener('dragenter', handleDragEnter, false);
            row.addEventListener('dragover', handleDragOver, false);
            row.addEventListener('dragleave', handleDragLeave, false);
            row.addEventListener('drop', handleDrop, false);
            row.addEventListener('dragend', handleDragEnd, false);
        }

        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('over');
        }

        function handleDragLeave(e) {
            this.classList.remove('over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (dragSrcEl != this) {
                dragSrcEl.innerHTML = this.innerHTML;
                this.innerHTML = e.dataTransfer.getData('text/html');
            }

            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            
            document.querySelectorAll('.draggable').forEach(function (row) {
                row.classList.remove('over');
            });

            adjustTableLayout();
        }

        function toggleWidth() {
            isEqualWidth = !isEqualWidth;
            document.body.classList.toggle('equal-width');
            adjustTableLayout();
            document.getElementById('toggle-width-button').textContent = 
                isEqualWidth ? '切換到自適應寬度' : '切換到等寬';
        }

        function adjustTableWidth(value) {
            document.querySelector('.table-container').style.width = value + '%';
            document.querySelector('.editor-container').style.width = (95 - value) + '%';
        }

        document.getElementById('add-row-button').addEventListener('click', () => addNewRow(1));
        document.getElementById('add-common-row-button').addEventListener('click', () => addNewRow(4));
        document.getElementById('add-two-device-row-button').addEventListener('click', () => addNewRow(2));
        document.getElementById('paste-button').addEventListener('click', pasteToCell);
        document.getElementById('toggle-width-button').addEventListener('click', toggleWidth);
        document.getElementById('width-control').addEventListener('input', (e) => adjustTableWidth(e.target.value));

        document.getElementById('export-button').addEventListener('click', () => {
            html2canvas(document.querySelector('table')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'comparison.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        function loadHtml2Canvas() {
            const script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            script.onload = () => console.log("html2canvas loaded");
            document.head.appendChild(script);
        }

        loadHtml2Canvas();
        initQuill();
        adjustTableLayout();

        // 为现有的行添加拖动功能
        document.querySelectorAll('.draggable').forEach(addDragHandlers);
    </script>
</body>
</html>